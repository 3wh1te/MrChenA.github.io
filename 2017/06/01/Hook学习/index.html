<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="articles," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="1、Hook原理API Hooking有两种，内核态级别的和用户态级别的。内核态级别的API Hooking也是很多病毒的实现原理，而且在微软不断强化其PatchGuard技术之后，已经越来越困难。做为建设四化的四有青年，我们还是把精力集中在用户态级别的API Hooking上好了。用户态的API Hooking其实就是为了在应用程序和Windows之间插一脚，从而达到用户调用的不再直接是Wind">
<meta name="keywords" content="articles">
<meta property="og:type" content="article">
<meta property="og:title" content="Hook学习">
<meta property="og:url" content="http://yoursite.com/2017/06/01/Hook学习/index.html">
<meta property="og:site_name" content="Mr.Chen --勿忘初衷">
<meta property="og:description" content="1、Hook原理API Hooking有两种，内核态级别的和用户态级别的。内核态级别的API Hooking也是很多病毒的实现原理，而且在微软不断强化其PatchGuard技术之后，已经越来越困难。做为建设四化的四有青年，我们还是把精力集中在用户态级别的API Hooking上好了。用户态的API Hooking其实就是为了在应用程序和Windows之间插一脚，从而达到用户调用的不再直接是Wind">
<meta property="og:updated_time" content="2017-06-03T14:54:53.996Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hook学习">
<meta name="twitter:description" content="1、Hook原理API Hooking有两种，内核态级别的和用户态级别的。内核态级别的API Hooking也是很多病毒的实现原理，而且在微软不断强化其PatchGuard技术之后，已经越来越困难。做为建设四化的四有青年，我们还是把精力集中在用户态级别的API Hooking上好了。用户态的API Hooking其实就是为了在应用程序和Windows之间插一脚，从而达到用户调用的不再直接是Wind">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/06/01/Hook学习/"/>





  <title>Hook学习 | Mr.Chen --勿忘初衷</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mr.Chen --勿忘初衷</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">勿忘初衷</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/01/Hook学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mr.Chen --勿忘初衷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Hook学习</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T21:04:33+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/01/Hook学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/06/01/Hook学习/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/06/01/Hook学习/" class="leancloud_visitors" data-flag-title="Hook学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1、Hook原理"><a href="#1、Hook原理" class="headerlink" title="1、Hook原理"></a>1、Hook原理</h1><p>API Hooking有两种，内核态级别的和用户态级别的。内核态级别的API Hooking也是很多病毒的实现原理，而且在微软不断强化其PatchGuard技术之后，已经越来越困难。做为建设四化的四有青年，我们还是把精力集中在用户态级别的API Hooking上好了。用户态的API Hooking其实就是为了在应用程序和Windows之间插一脚，从而达到用户调用的不再直接是Windows提供的函数，而是调用我们提供的函数。我们可以选择把调用转交给真正的Windows提供的函数，也可以选择自己处理掉，如果我们知道怎么处理的话。API Hooking非常强大可以应用在很多地方，比如监测（非安全领域，因为很容易绕过），虚拟化，软件破解等。要实现API Hooking有很多选择，基本上可以分为：</p>
<a id="more"></a>
<p>1、木马DLL<br>2、修改导出表</p>
<p>3、修改导入表<br>4、代码重写</p>
<p>实现的难易程度也基本上是上述的顺序。木马DLL是最好实现的，前年我因为需要解码nellymoser编码的音频，但是只有Flash播放器才有它的解码器。所以我就把winmm.dll这个系统提供多媒体功能的dll做了一个木马，实现了拦截wav输出的目的。木马DLL只需要你写一个同名的dll，导出相同名字和签名的函数即可。不过它的限制也最大，最大的原因是windows核心的DLL是不会从当前目录加载的（比如user32.dll），同时它还要求木马DLL必须预先放置在exe的同级目录下。<br>修改导出和导入表限制也很大。真正的王道是代码重写，不过难度陡增。在这个方面比较出名的有Detours（微软研究院的，不过已经没更新了），和madshi（DELPHI领域的，用户众多）。不过最近新出了一种非常强大的库，叫EasyHook。它具有非常独特的特性，支持.NET。也就是说，你可以用C#来写API钩子。这在以前是无法想象的。<a href="http://easyhook.github.io/" target="_blank" rel="external">它的项目地址是这里</a>。 EasyHook其实不光是一个API Hook的库，它还提供了Remote Injection（远程注入）的功能。也就是说，你不但能够在Hook当前进程的API，还能去Hook其他进程的API。</p>
<p>所谓代码重写，是指修改DLL映射到当前进程的内存中的代码（二进制的机器指令）。每个API都会在运行时解析出一个地址，然后程序会用call指令去调用这个地址所包含的机器指令。代码重写就是把这个地址所在位置的机器指令重写了，从而达到从中插一脚的目的。简化后的流程为：</p>
<p>1、调用API地址所在处的指令</p>
<p>2、被改写的代码被执行（一般就是一个jmp指令，跳转到一个更开阔的地方去做更多的事情）</p>
<p>3、执行Hook</p>
<p>4、执行被覆盖的指令（一般是5个字节）</p>
<p>5、跳转回（API地址所在处+5个字节）的位置继续执行原代码</p>
<p>要完成这样一个流程已经很不容易。它需要你懂得80x86的汇编语言，而且要有很强的debug能力。但是这只是一个简化的流程，真正复杂的地方在于：</p>
<p>1、不可覆盖的代码的监测（比如jne就无法被覆盖）</p>
<p>2、Hook的可靠卸载</p>
<p>3、被覆盖指令长度的确定（一般是5个字节，但是那只是一般）</p>
<p>4、不同CPU指令集的支持（64位？）</p>
<p>5、Hook中调用了被Hook的API怎么办？</p>
<p>对于上述问题考虑的周到与否是衡量一个API Hook库的标准。很高兴的告诉你，EasyHook把上述问题都考虑进去了。而且依靠CLR Hosting API，EasyHook还实现了.NET的API钩子。原理就是EasyHook自己先把API调用拦截下来，然后用CLR Hosting API启动一个CLR的runtime，然后用runtime去加载一个GAC中的Assembly，然后用反射去调用你的代码，并且给你提供了足够的RuntimeInfo，使得你可以知道当前的环境，以及回调原始的API。不过仍然在Hook系统的API的时候，仍然要非常小心死锁的问题。<br>EasyHook也不是完美的。据我个人测试，它远程Hook .NET产生出来的exe有问题。不过这是它的Remote Injection部分的问题（很可能是CreateRemoteThread与CLR冲突导致的）。而且EasyHook确定指令长度那块内嵌的反汇编器来路不明（作者自述是从一个德文论坛上下载的程序反汇编来的），其实可以考虑用distorm代替。</p>
<p>其内部实现有一段关键的汇编代码叫trampoline（蹦床）。这段代码就是那被覆盖的5个字节要jmp到的一段代码，它负责调用你的Hook和善后。所以说如果你用的是.NET写的钩子，这是一个三级跳的过程：</p>
<p>1、应用程序调用API</p>
<p>2、API被调用（其实是我们的jmp指令被调用，因为头5个字节被覆盖了）<br>3、那个5个字节的jmp，跳转到了trampoline，这蹦床被jmp了，哈哈，所以弹了回去</p>
<p>4、trampoline跳转到了EasyHook的Thread Deadlock Barrier</p>
<p>5、EasyHook再用CLR Hosting API跳转到了我们的.NET代码</p>
<p>转载于<a href="http://www.cnblogs.com/taowen/archive/2008/10/31/1324016.html" target="_blank" rel="external">这里</a><br><br><a href="http://easyhook.github.io/" target="_blank" rel="external">EasyHook地址</a></p>
<h1 id="2、EasyHook使用"><a href="#2、EasyHook使用" class="headerlink" title="2、EasyHook使用"></a>2、EasyHook使用</h1><p><a href="http://blog.csdn.net/yuzehome/article/details/18450433" target="_blank" rel="external">教程</a></p>
<h1 id="3、Detour使用-下载链接"><a href="#3、Detour使用-下载链接" class="headerlink" title="3、Detour使用   下载链接"></a>3、Detour使用 <a href="http://download.csdn.net/download/staver102/7648875" target="_blank" rel="external">  下载链接</a></h1><h2 id="1、VS编译出错"><a href="#1、VS编译出错" class="headerlink" title="1、VS编译出错"></a>1、VS编译出错</h2><p>c:\evan\workspace\1\1\netwowkippack.h(50) : error C2146: 语法错误 : 缺少“;”(在标识符“nSourPort”的前面)<br>c:\evan\workspace\1\1\netwowkippack.h(50) : error C4430: 缺少类型说明符 - 假定为 int。注意: C++ 不支持默认 int<br>c:\evan\workspace\1\1\netwowkippack.h(50) : error C4430: 缺少类型说明符 - 假定为 int。注意: C++ 不支持默认 int<br>c:\evan\workspace\1\1\netwowkippack.h(51) : error C2146: 语法错误 : 缺少“;”(在标识符“nDestPort”的前面)<br>c:\evan\workspace\1\1\netwowkippack.h(51) : error C4430: 缺少类型说明符 - 假定为 int。注意: C++ 不支持默认 int</p>
<p>总结了一下，主要有以下原因：</p>
<ol>
<li><p>（此情况经常出现在大型工程项目中）如果存在两个类的头文件a.h和b.h,在a.h中有这样的语句：#include “b.h”,在b.h文件中有这样的语句：#include “a.h”   且在一个类中有另一个类的对象时   那么就会出现这样的错误。</p>
</li>
<li><p>没有包含要定义的类的头文件。</p>
</li>
</ol>
<p>3.项目中少加了宏定义，导致头文件重复定义或相应宏无法识别。</p>
<p>4.当有多个头文件时，顺序写反也可能导致相关的错误，其根本是头文件中的预编译语句被隐去了。</p>
<p>e.g</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">#include &lt;Windows.h&gt;</div><div class="line"></div><div class="line">#include &lt;WinCrypt.h&gt;</div><div class="line"></div><div class="line">#include &lt;string.h&gt;</div></pre></td></tr></table></figure>
<p>如果把第二个和第三个写反，一个宏定义就被#if给注了，就会出现类似错误</p>
<p><a href="http://mfvan.blog.163.com/blog/static/58895190201023042012727/" target="_blank" rel="external">转载自链接</a></p>
<h2 id="2、Detours"><a href="#2、Detours" class="headerlink" title="2、Detours"></a>2、Detours</h2><p>(1) Target函数：要拦截的函数，通常为Windows的API。 </p>
<p>(2) Trampoline函数：Target函数的复制品。因为Detours将会改写Target函数，所以先把Target函数复制保存好，一方面仍然保存Target函数的过程调用语义，另一方面便于以后的恢复。</p>
<p>(3) Detour 函数：用来替代Target函数的函数。</p>
<p>(4) Detours在Target函数的开头加入JMP Address<em>of</em> Detour_ Function指令（共5个字节）把对Target函数的调用引导到自己的Detour函数， 把Target函数的开头的5个字节加上JMP Address<em>of</em> Target _ Function+5作为Trampoline函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">DetourAttach((PVOID *)&amp;pPresent, New_Present);  </div><div class="line">DWORD nErr = DetourTransactionCommit();  </div><div class="line">pPresent传入前的值为5d0a10c3，传入后的值为5ce50060（DetourTransactionCommit后）  </div><div class="line">0:000&gt; u 5d0a10c3    //Hook前函数汇编  </div><div class="line">d3d9!CBaseDevice::Present:  </div><div class="line">5d0a10c3 8bff            mov     edi,edi  </div><div class="line">5d0a10c5 55              push    ebp  </div><div class="line">5d0a10c6 8bec            mov     ebp,esp  </div><div class="line">5d0a10c8 56              push    esi  </div><div class="line">5d0a10c9 57              push    edi  </div><div class="line">5d0a10ca 8b7d08          mov     edi,dword ptr [ebp+8]  </div><div class="line">5d0a10cd 85ff            test    edi,edi  </div><div class="line">5d0a10cf 7444            je      d3d9!CBaseDevice::Present+0x13 (5d0a1115)  </div><div class="line">  </div><div class="line">d3d9!CBaseDevice::Present://Hook后函数汇编  </div><div class="line">5d0a10c3 e9dc002fa3      jmp     FpsTool1!ILT+415(?New_PresentYGJPAUIDirect3DDevice9PBUtagRECT (003911a4)  //5个字节  </div><div class="line">5d0a10c8 56              push    esi  </div><div class="line">5d0a10c9 57              push    edi  </div><div class="line">5d0a10ca 8b7d08          mov     edi,dword ptr [ebp+8]  </div><div class="line">5d0a10cd 85ff            test    edi,edi  </div><div class="line">5d0a10cf 7444            je      d3d9!CBaseDevice::Present+0x13 (5d0a1115)  </div><div class="line">5d0a10d1 8d7704          lea     esi,[edi+4]  </div><div class="line">5d0a10d4 837e1800        cmp     dword ptr [esi+18h],0  </div><div class="line">  </div><div class="line">  </div><div class="line">0:000&gt; u 5ce50060//Hook后pPresent的值，我们可以看到是保存了Hook前函数汇编的前五个字节，再跳转回前面函数  </div><div class="line">5ce50060 8bff            mov     edi,edi  </div><div class="line">5ce50062 55              push    ebp  </div><div class="line">5ce50063 8bec            mov     ebp,esp  </div><div class="line">5ce50065 e95e102500      jmp     d3d9!CBaseDevice::Present+0x5 (5d0a10c8)</div></pre></td></tr></table></figure>
<p>在Detours库中，驱动detours执行的是函数 DetourAttach(…)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">LONG DetourAttach(</div><div class="line"></div><div class="line">    PVOID * ppPointer,</div><div class="line"></div><div class="line">    PVOID pDetour</div><div class="line"></div><div class="line">    );</div></pre></td></tr></table></figure>
<p>这个函数的职责是挂接目标API，函数的第一个参数是一个指向将要被挂接函数地址的函数指针，第二个参数是指向实际运行的函数的指针，一般来说是我们定义的替代函数的地址。<br>注意：我们自定义的替代函式一定要与被hook的函数具有相同的参数和返回值。例如，send函数的定义是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">int send(</div><div class="line"></div><div class="line">  __in  SOCKET s,</div><div class="line"></div><div class="line">  __in  const char *buf,</div><div class="line"></div><div class="line">  __in  int len,</div><div class="line"></div><div class="line">  __in  int flags</div><div class="line"></div><div class="line">);</div></pre></td></tr></table></figure>
<p>因此，指向这个函数的指针看起来应该是这样的：</p>
<p>int (WINAPI <em>pSend)(SOCKET, const char</em>, int, int) = send;</p>
<p>把函数指针初始化成真正的函数地址是ok的；另外还有一种方式是把函数指针初始化为NULL，然后用函数DetourFindFunction(…) 指向真正的函式地址.把send(…) 和 recv(…)初始化:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">int (WINAPI *pSend)(SOCKET s, const char* buf, int len, int flags) = send;</div><div class="line"></div><div class="line">int WINAPI MySend(SOCKET s, const char* buf, int len, int flags);</div><div class="line"></div><div class="line">int (WINAPI *pRecv)(SOCKET s, char* buf, int len, int flags) = recv;</div><div class="line"></div><div class="line">int WINAPI MyRecv(SOCKET s, char* buf, int len, int flags);</div></pre></td></tr></table></figure>
<p>现在，需要hook的函数和重定向到的函数已经定义好了。这里使用 WINAPI 是因为这些函数是用 __stdcall 返回值的导出函数，现在开始hook:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">INT APIENTRY DllMain(HMODULE hDLL, DWORD Reason, LPVOID Reserved)</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">    switch(Reason)</div><div class="line"></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        case DLL_PROCESS_ATTACH:</div><div class="line"></div><div class="line">            DisableThreadLibraryCalls(hDLL);</div><div class="line"></div><div class="line">            DetourTransactionBegin();</div><div class="line"></div><div class="line">            DetourUpdateThread(GetCurrentThread());</div><div class="line"></div><div class="line">            DetourAttach(&amp;(PVOID&amp;)pSend, MySend);</div><div class="line"></div><div class="line">            if(DetourTransactionCommit() == NO_ERROR)</div><div class="line"></div><div class="line">                OutputDebugString(&quot;send() detoured successfully&quot;);</div><div class="line"></div><div class="line">            DetourTransactionBegin();</div><div class="line"></div><div class="line">            DetourUpdateThread(GetCurrentThread());</div><div class="line"></div><div class="line">            DetourAttach(&amp;(PVOID&amp;)pRecv, MyRecv);</div><div class="line"></div><div class="line">            if(DetourTransactionCommit() == NO_ERROR)</div><div class="line"></div><div class="line">                OutputDebugString(&quot;recv() detoured successfully&quot;);</div><div class="line"></div><div class="line">            break;</div></pre></td></tr></table></figure>
<p>它基本上是用上面介绍的步骤开始和结束 —— 初始化，更新detours线程，用DetourAttach(…)开始hook函数，最后调用DetourTransactionCommit() 函数, 当调用成功时返回 NO_ERROR, 失败是返回一些错误码.下面是我们的函数的实现，我发送和接收的信息写入到一个日志文件中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">int WINAPI MySend(SOCKET s, const char* buf, int len, int flags)</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">    fopen_s(&amp;pSendLogFile, &quot;C:\\SendLog.txt&quot;, &quot;a+&quot;);</div><div class="line"></div><div class="line">    fprintf(pSendLogFile, &quot;%s\n&quot;, buf);</div><div class="line"></div><div class="line">    fclose(pSendLogFile);</div><div class="line"></div><div class="line">    return pSend(s, buf, len, flags);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">int WINAPI MyRecv(SOCKET s, char* buf, int len, int flags)</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">    fopen_s(&amp;pRecvLogFile, &quot;C:\\RecvLog.txt&quot;, &quot;a+&quot;);</div><div class="line"></div><div class="line">    fprintf(pRecvLogFile, &quot;%s\n&quot;, buf);</div><div class="line"></div><div class="line">    fclose(pRecvLogFile);</div><div class="line"></div><div class="line">    return pRecv(s, buf, len, flags);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还可以hook自定义的c函数、hook类成员函数</p>
<p><a href="http://blog.163.com/weiming886521365@126/blog/static/331150742011223851824/" target="_blank" rel="external">链接</a></p>
<h2 id="3、无法解析的外部命令"><a href="#3、无法解析的外部命令" class="headerlink" title="3、无法解析的外部命令"></a>3、无法解析的外部命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1&gt;Test.obj : error LNK2019: 无法解析的外部符号 _DetourTransactionBegin@0，该符号在函数 &quot;void __cdecl Hook(void)&quot; (?Hook@@YAXXZ) 中被引用</div><div class="line">1&gt;Test.obj : error LNK2019: 无法解析的外部符号 _DetourTransactionCommit@0，该符号在函数 &quot;void __cdecl Hook(void)&quot; (?Hook@@YAXXZ) 中被引用</div><div class="line">1&gt;Test.obj : error LNK2019: 无法解析的外部符号 _DetourUpdateThread@4，该符号在函数 &quot;void __cdecl Hook(void)&quot; (?Hook@@YAXXZ) 中被引用</div><div class="line">1&gt;Test.obj : error LNK2019: 无法解析的外部符号 _DetourAttach@8，该符号在函数 &quot;void __cdecl Hook(void)&quot; (?Hook@@YAXXZ) 中被引用</div><div class="line">1&gt;Test.obj : error LNK2019: 无法解析的外部符号 _DetourDetach@8，该符号在函数 &quot;void __cdecl UnHook(void)&quot; (?UnHook@@YAXXZ) 中被引用</div><div class="line">1&gt;Test.obj : error LNK2019: 无法解析的外部符号 _DetourRestoreAfterWith@0，该符号在函数 &quot;void __cdecl Hook(void)&quot; (?Hook@@YAXXZ) 中被引用</div><div class="line">1&gt;D:\勒索软件的预防\project\Test\Debug\Test.exe : fatal error LNK1120: 6 个无法解析的外部命令</div></pre></td></tr></table></figure>
<p>使用VS2012的时候编译出错，出现这个原因两种：<br>1.没有引相应的库 #include “detours.lib”<br>2.引错库了（我就属于后者），因为新建的是win32的程序所以需要引x86的库，如果没有x86的库，可以修改平台配置，改成x64。</p>
<h2 id="4、一些重要函数"><a href="#4、一些重要函数" class="headerlink" title="4、一些重要函数"></a>4、一些重要函数</h2><h3 id="1-DetourAttach和DetourDetach"><a href="#1-DetourAttach和DetourDetach" class="headerlink" title="1.DetourAttach和DetourDetach"></a>1.DetourAttach和DetourDetach</h3><p>之前提过，这里就不详细说了。</p>
<h3 id="2-DetourRestoreAfterWith"><a href="#2-DetourRestoreAfterWith" class="headerlink" title="2.DetourRestoreAfterWith"></a>2.DetourRestoreAfterWith</h3><p><strong>Definition</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BOOL DetourRestoreAfterWith(VOID);</div></pre></td></tr></table></figure>
<p><strong>Return value</strong></p>
<p>Returns true if the necessary payload was found and the restore succeeded.</p>
<p><strong>Error codes</strong></p>
<p>The function sets one of the following error codes if it was unable to find the necessary payload or restore the import table. The error code may be retrived after the function has returned by calling GetLastError.</p>
<p>ERROR_MOD_NOT_FOUND<br>Could not find the necessary payload.</p>
<p><strong>Remarks</strong></p>
<p>The DetourCreateProcessWithDllEx API modifies the in-memory import table of the target PE binary program in the new process it creates. For correct application compatibilty, the changes to the import table should be removed before the application runs. To remove these changes, DetourCreateProcessWithDllEx copies relevant reversal data into a payload in the target process using the DetourCopyPayloadToProcess API. When called in the target process, DetourRestoreAfterWith searches for the necessary payloaded and restores the contents of the import table.</p>
<p>For correct results, DetourRestoreAfterWith should be called in the PROCESS_ATTACH portion of the DllMain function of the DLL loaded into the target process.</p>
<h3 id="3-DetourTransactionBegin和DetourTransactionCommit"><a href="#3-DetourTransactionBegin和DetourTransactionCommit" class="headerlink" title="3.DetourTransactionBegin和DetourTransactionCommit"></a>3.DetourTransactionBegin和DetourTransactionCommit</h3><h3 id="4-DetourUpdateThread"><a href="#4-DetourUpdateThread" class="headerlink" title="4.DetourUpdateThread"></a>4.DetourUpdateThread</h3><p>Enlist a thread for update in the current transaction.</p>
<p>Definition<br>LONG DetourUpdateThread(<br>    <em>In</em> HANDLE hThread<br>    );<br>Parameters<br>hThread<br>The handle of the thread to be updated with the pending transaction.<br>Return value<br>Returns NO_ERROR if successful; otherwise, returns an error code.</p>
<p>Error codes<br>ERROR_NOT_ENOUGH_MEMORY<br>Not enough memory to record identity of thread.<br>Remarks<br>DetourUpdateThread enlists the specified thread for update when the current transaction, opened by the DetourTransactionBegin API, commits.</p>
<p>When a detour transaction commmits, Detours insures that all threads enlisted in the transcation via the DetourUpdateThread API are updated if their instruction pointer lies within the rewritten code in either the target function or the trampoline function.</p>
<p>Threads not enlisted in the transaction are not updated when the transaction commits. As a result, they may attempt to execute an illegal combination of old and new code.</p>
<h3 id="5-DetourCreateProcessWithDll"><a href="#5-DetourCreateProcessWithDll" class="headerlink" title="5.DetourCreateProcessWithDll"></a>5.DetourCreateProcessWithDll</h3><p>在Detour DLL被加载之后，它应该通过调用DetourRestoreAfterWith来反转对内存中引用表的更改。 为了方便逆转这些更改，DetourCreateProcessWithDll使用DetourCopyPayloadToProcess API将相关的反转数据复制到目标进程的有效负载中。 加载的DLL应该调用DetourRestoreAfterWith API来恢复导入表的内容。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/articles/" rel="tag"># articles</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/26/CTF/" rel="next" title="CTF">
                <i class="fa fa-chevron-left"></i> CTF
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Mr.Chen" />
          <p class="site-author-name" itemprop="name">Mr.Chen</p>
           
              <p class="site-description motion-element" itemprop="description">Write everyday</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/tags/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MrChenA" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/chen-yan-hui-5-88" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/3196979860" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1、Hook原理"><span class="nav-number">1.</span> <span class="nav-text">1、Hook原理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2、EasyHook使用"><span class="nav-number">2.</span> <span class="nav-text">2、EasyHook使用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3、Detour使用-下载链接"><span class="nav-number">3.</span> <span class="nav-text">3、Detour使用   下载链接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、VS编译出错"><span class="nav-number">3.1.</span> <span class="nav-text">1、VS编译出错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、Detours"><span class="nav-number">3.2.</span> <span class="nav-text">2、Detours</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、无法解析的外部命令"><span class="nav-number">3.3.</span> <span class="nav-text">3、无法解析的外部命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、一些重要函数"><span class="nav-number">3.4.</span> <span class="nav-text">4、一些重要函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-DetourAttach和DetourDetach"><span class="nav-number">3.4.1.</span> <span class="nav-text">1.DetourAttach和DetourDetach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-DetourRestoreAfterWith"><span class="nav-number">3.4.2.</span> <span class="nav-text">2.DetourRestoreAfterWith</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-DetourTransactionBegin和DetourTransactionCommit"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.DetourTransactionBegin和DetourTransactionCommit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-DetourUpdateThread"><span class="nav-number">3.4.4.</span> <span class="nav-text">4.DetourUpdateThread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-DetourCreateProcessWithDll"><span class="nav-number">3.4.5.</span> <span class="nav-text">5.DetourCreateProcessWithDll</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Chen</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2017/06/01/Hook学习/';
          this.page.identifier = '2017/06/01/Hook学习/';
          this.page.title = 'Hook学习';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("MJnlsvNexA0FYtyNkI8cgo9y-gzGzoHsz", "xxpud92U58R0TiwQEXWrCCcK");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

</body>
</html>
